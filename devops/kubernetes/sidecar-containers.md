# Sidecar Containers

## Task

> We have a web server container running the nginx image. The access and error logs generated by the web server are not critical enough to be placed on a persistent volume. However, Nautilus developers need access to the last 24 hours of logs so that they can trace issues and bugs. Therefore, we need to ship the access and error logs for the web server to a log-aggregation service. Following the separation of concerns principle, we implement the Sidecar pattern by deploying a second container that ships the error and access logs from nginx. Nginx does one thing, and it does it well—serving web pages. The second container also specializes in its task—shipping logs. Since containers are running on the same Pod, we can use a shared emptyDir volume to read and write logs.
>
> Create a pod named `webserver`.
> Create an `emptyDir` volume `shared-logs`.
> Create two containers from `nginx` and `ubuntu`images with latest tag only and remember to mention tag i.e nginx:latest, nginx container name should be nginx-container and ubuntu container name should be sidecar-container on webserver pod.
> Add command on `sidecar-container` `"sh","-c","while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"`
> Mount the volume `shared-logs`on both containers at location `var/log/nginx`, all containers should be up and running.

## Preliminary Steps

1. Check the architecture map at <https://www.lucidchart.com/documents/view/58e22de2-c446-4b49-ae0f-db79a3318e97/0_0>
2. Check server details at <https://kodekloudhub.github.io/kodekloud-engineer/docs/projects/nautilus>

## Research

* Commands
  * https://kubernetes.io/docs/concepts/workloads/pods/
  * https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/
* emptyDir
  * https://kubernetes.io/docs/concepts/storage/volumes/#emptydir
* Ports
  * https://kubernetes.io/docs/tutorials/services/connect-applications-service/

## Steps

Follow the [k8s environment setup steps.](setup-k8s-env.md).

```bash
# Check cluster connection
k get no -o wide
```

```
NAME                      STATUS   ROLES           AGE   VERSION                     INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                                      KERNEL-VERSION   CONTAINER-RUNTIME
kodekloud-control-plane   Ready    control-plane   21m   v1.27.3-44+b5c876a05b7bbd   172.17.0.2    <none>        Ubuntu Mantic Minotaur (development branch)   5.4.0-1106-gcp   containerd://1.7.1-2-g8f682ed69
```

```bash
# Create Pod YAML
cat > pod.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webserver
spec:
  containers:
  - image: nginx:latest
    name: nginx-container
    ports:
    - containerPort: 80
    volumeMounts:
    - mountPath: /var/log/nginx
      name: shared-logs
  - image: ubuntu:latest
    name: sidecar-container
    command: ["sh","-c","while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"]
    volumeMounts:
    - mountPath: /var/log/nginx
      name: shared-logs
  volumes:
  - name: shared-logs
    emptyDir:
      sizeLimit: 128Mi
```

```bash
# Create the Pod.
k apply -f po

# View the Pod's state.
k describe po
```

<details>
  <summary><b>NOTE:</b> Click me for output.</summary>

```
Name:             webserver
Namespace:        default
Priority:         0
Service Account:  default
Node:             kodekloud-control-plane/172.17.0.2
Start Time:       Thu, 12 Oct 2023 08:38:38 +0000
Labels:           <none>
Annotations:      <none>
Status:           Running
IP:               10.244.0.6
IPs:
  IP:  10.244.0.6
Containers:
  nginx-container:
    Container ID:   containerd://61173fd7d459749529f3c0d20c44b488a158377b9b68a361058199d89b099a4c
    Image:          nginx:latest
    Image ID:       docker.io/library/nginx@sha256:ee95754109927fbf510f008ee0a24620dff190f4d550b5787d1eaaddb9fd5ffd
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Thu, 12 Oct 2023 08:38:40 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/log/nginx from shared-logs (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-9cvrt (ro)
  sidecar-container:
    Container ID:  containerd://25adf914e9cb3b4839df864dac86b5c70291531265f59569fa6cf04178413380
    Image:         ubuntu:latest
    Image ID:      docker.io/library/ubuntu@sha256:9b8dec3bf938bc80fbe758d856e96fdfab5f56c39d44b0cff351e847bb1b01ea
    Port:          <none>
    Host Port:     <none>
    Command:
      sh
      -c
      while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done
    State:          Running
      Started:      Thu, 12 Oct 2023 08:38:41 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/log/nginx from shared-logs (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-9cvrt (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  shared-logs:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:
    SizeLimit:  128Mi
  kube-api-access-9cvrt:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  4s    default-scheduler  Successfully assigned default/webserver to kodekloud-control-plane
  Normal  Pulling    2s    kubelet            Pulling image "nginx:latest"
  Normal  Pulled     2s    kubelet            Successfully pulled image "nginx:latest" in 366.935238ms (366.966852ms including waiting)
  Normal  Created    2s    kubelet            Created container nginx-container
  Normal  Started    2s    kubelet            Started container nginx-container
  Normal  Pulling    2s    kubelet            Pulling image "ubuntu:latest"
  Normal  Pulled     1s    kubelet            Successfully pulled image "ubuntu:latest" in 474.549811ms (474.571109ms including waiting)
  Normal  Created    1s    kubelet            Created container sidecar-container
  Normal  Started    1s    kubelet            Started container sidecar-container
```

</details>

```bash
# Hit nginx from inside the nginx container.
k exec webserver -c nginx-container -- curl localhost:80
```

<details>
  <summary><b>NOTE:</b> Click me for output.</summary>

```
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
100   615  100   615    0     0   715k      0 --:--:-- --:--:-- --:--:--  600k
```

</details>

```bash
# View the nginx logs from inside the sidecar container.
k exec webserver -c sidecar-container -- cat /var/log/nginx/access.log
```

```
127.0.0.1 - - [12/Oct/2023:08:47:53 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/7.88.1" "-"
```

We are done.
